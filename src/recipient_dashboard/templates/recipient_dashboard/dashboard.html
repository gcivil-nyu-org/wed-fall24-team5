{% extends "_base.html" %} 
{% load dashboard_filters %} 
{% block title %} Donation Dashboard {% endblock title %} 

{% block extra_head %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const locationBtn = document.getElementById('use-location-btn');
    const addressInput = document.getElementById('location-input');

    locationBtn.addEventListener('click', function() {
        if (!navigator.geolocation) {
            alert('Geolocation is not supported by your browser');
            return;
        }

        locationBtn.classList.add('is-loading');

        navigator.geolocation.getCurrentPosition(
            function(position) {
                fetch(`https://nominatim.openstreetmap.org/reverse?lat=${position.coords.latitude}&lon=${position.coords.longitude}&format=json`)
                    .then(response => response.json())
                    .then(data => {
                        addressInput.value = data.display_name;
                        addressInput.form.submit();
                    })
                    .catch(error => {
                        console.error('Error getting address:', error);
                        alert('Unable to get your address. Please enter it manually.');
                    })
                    .finally(() => {
                        locationBtn.classList.remove('is-loading');
                    });
            },
            function(error) {
                locationBtn.classList.remove('is-loading');
                let message = 'An unknown error occurred while getting location.';
                if (error.code === error.PERMISSION_DENIED) {
                    message = 'Please enable location access to use this feature.';
                } else if (error.code === error.POSITION_UNAVAILABLE) {
                    message = 'Location information is unavailable.';
                } else if (error.code === error.TIMEOUT) {
                    message = 'Location request timed out.';
                }
                alert(message);
            }
        );
    });
});
</script>
{% endblock %}

{% block content %}
<div class="container">
    {% include "partials/notifications.html" %}

    <h1 class="title mt-5">Welcome, {{ user.first_name }} {{ user.last_name }}!</h1>

    {% csrf_token %}

    <div class="card">
        <div class="card-content">
            <div class="columns is-multiline is-centered">
                <div class="column is-three-quarters">
                    <div class="field has-addons has-addons-centered">
                        <div class="control">
                            {{ form.type }}
                        </div>
                        <div class="control is-expanded">
                            {{ form.keyword }}
                        </div>
                    </div>
                </div>

                <div class="column is-one-quarter">
                    <div class="field is-grouped is-grouped-centered">
                        <div class="control">
                            <button type="submit" class="button is-primary">Search</button>
                        </div>
                        <div class="control">
                            <a href="{% url 'recipient_dashboard' %}" class="button is-danger">Clear all</a>
                        </div>
                    </div>
                </div>

                <div class="column">
                    <div class="field">
                        <label class="label">Organization Type</label>
                        <div class="control is-expanded">
                            {{ form.category }}
                        </div>
                    </div>
                </div>

                <div class="column">
                    <div class="field">
                        <label class="label">Pickup Date After</label>
                        <div class="control">
                            {{ form.date }}
                        </div>
                    </div>
                </div>

                <div class="column">
                    <div class="field">
                        <label class="label">Quantity Available</label>
                        <div class="control">
                            {{ form.min_quantity }}
                        </div>
                    </div>
                </div>

                <div class="column is-half">
                    <div class="field">
                        <label class="label">Location</label>
                        <div class="columns is-mobile is-gapless mb-0">
                            <div class="column">
                                <div class="field has-addons">
                                    <div class="control is-expanded">
                                        {{ form.address }}
                                    </div>
                                    <div class="control">
                                        <button type="button" id="use-location-btn" class="button is-info">
                                            <span class="icon">
                                                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                                    <circle cx="12" cy="12" r="10"></circle>
                                                    <line x1="12" y1="8" x2="12" y2="16"></line>
                                                    <line x1="8" y1="12" x2="16" y2="12"></line>
                                                </svg>
                                            </span>
                                            <span>Use My Location</span>
                                        </button>
                                    </div>
                                </div>
                            </div>
                            <div class="column is-narrow ml-3" style="margin-top: -33px;">
                                <div class="field">
                                    <div class="control">
                                        Radius {{ form.radius }}
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="level-left">
        <div class="level-item">
            <h2 class="subtitle">Available Donations</h2>
        </div>
        <div class="level-item ml-3">
            <a href="{% url 'recipient_stats' %}" class="icon-text has-text-link">
                View My Stats
                <span class="icon"></span>
            </a>
        </div>
    </div>

    {% if donations %}
        <div class="column is-full-mobile has-text-centered">
            <div class="card pt-2 pb-2">
                <div class="card-content">
                    <p>Organizations</p>
                    <p>{{ org_count }}</p>
                </div>
            </div>
        </div>

        <div class="column is-full-mobile has-text-centered">
            <div class="card pt-2 pb-2">
                <div class="card-content">
                    <p>Donations</p>
                    <p>{{ donations|length }}</p>
                </div>
            </div>
        </div>

        <div class="column is-full-mobile has-text-centered">
            <div class="card pt-2 pb-2">
                <div class="card-content">
                    <p>Total Items</p>
                    <p>{{ total_items }}</p>
                </div>
            </div>
        </div>

        <div class="columns is-multiline is-variable is-4">
            {% for donation in donations %}
                <div class="column is-full-mobile is-half-tablet is-half-desktop">
                    <div class="card mb-5">
                        <div class="card-content">
                            <div class="level">
                                <div class="level-left">
                                    <div class="level-item">
                                        {{ donation.food_item }}
                                    </div>
                                </div>
                                <div class="level-right">
                                    <div class="level-item">
                                        <span class="tag is-primary is-light is-medium mt-3">
                                            {{ donation.quantity }} Available
                                        </span>
                                    </div>
                                </div>
                            </div>
                            <div class="content">
                                <div class="columns is-flex-direction-column-mobile">
                                    <div class="column is-two-thirds">
                                        <a href="https://www.google.com/maps/dir/?api=1&destination={{ donation.organization.address|urlencode }}"
                                           class="button is-link is-light is-fullwidth"
                                           style="white-space: normal; word-wrap: break-word; display: flex; flex-direction: column; align-items: flex-center;"
                                           target="_blank" rel="noopener noreferrer">
                                            {{ donation.organization.organization_name }} 
                                            {{ donation.organization.address }}
                                            {% if distances %}
                                                <span class="mt-1 has-text-weight-normal">
                                                    {{ distances|get_item:donation.organization.organization_id|floatformat:1 }} miles away
                                                </span>
                                            {% endif %}
                                            <span class="mt-1">
                                                {% if donation.avg_rating %}
                                                    {% with ""|center:5 as range %}
                                                        {% for _ in range %}
                                                            {% if forloop.counter <= donation.avg_rating %}
                                                                ★
                                                            {% elif forloop.counter < donation.avg_rating|floatformat:0|add:"1" %}
                                                                ★
                                                            {% else %}
                                                                ☆
                                                            {% endif %}
                                                        {% endfor %}
                                                    {% endwith %}
                                                {% else %}
                                                    <span class="has-text-grey-light">No ratings</span>
                                                {% endif %}
                                            </span>
                                        </a>
                                    </div>
                                    <div class="column is-one-third has-text-centered">
                                        <strong>Pickup by:</strong>
                                        <br>
                                        {{ donation.pickup_by }}
                                    </div>
                                </div>
                            </div>
                        </div>
                        <footer class="card-footer">
                            <a href="{% url 'reserve_donation' donation.donation_id %}" class="card-footer-item">Reserve</a>
                        </footer>
                    </div>
                </div>
            {% endfor %}
        </div>
    {% else %}
        <div class="notification is-info">
            No donations available at the moment.
        </div>
    {% endif %}
</div>
{% endblock content %}