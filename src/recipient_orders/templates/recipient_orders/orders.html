{% extends "_base.html" %}
{% load static %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/orders.css' %}">
{% endblock %}

{% block title %}My Orders{% endblock title %}
{% block content %}

<div class="container">
    {% include "partials/notifications.html" %}
    
    <h1 class="title">Hi, {{ user.first_name }} {{ user.last_name }}!</h1>
    <h2 class="subtitle mt-3">Your reservations:</h2>

    <div class="tabs is-centered is-toggle is-fullwidth">
        <ul>
            <li class="is-active" data-target="pending-orders">
                <a>Pending</a>
            </li>
            <li data-target="picked-up-orders">
                <a>Picked Up</a>
            </li>
            <li data-target="canceled-orders">
                <a>Canceled</a>
            </li>
        </ul>
    </div>

    <!-- Pending Orders Section -->
    <div id="pending-orders" class="order-list">
        {% if pending_orders %}
            <div class="columns is-multiline is-variable is-4">
                {% for order in pending_orders %}
                    <div class="column is-full-mobile is-half-tablet is-half-desktop">
                        <div class="card mb-5">
                            <div class="card-content">
                                <div class="media is-flex is-justify-content-space-between is-flex-direction-column-mobile">
                                    <div class="media-content">
                                        <p class="title is-4">{{ order.donation.food_item }}</p>
                                    </div>
                                    <div class="media-right mt-2-mobile">
                                        <span class="tag is-primary is-light is-medium mt-1">{{ order.order_quantity }} reserved</span>
                                    </div>
                                </div>

                                <div class="content">
                                    <div class="columns is-flex-direction-column-mobile">
                                        <div class="column is-two-thirds">
                                            <a href="https://www.google.com/maps/dir/?api=1&destination={{ order.donation.organization.address|urlencode }}"
                                               class="button is-link is-light is-fullwidth address-link"
                                               target="_blank" 
                                               rel="noopener noreferrer">
                                                {{ order.donation.organization.organization_name }}
                                                {{ order.donation.organization.address }}
                                            </a>
                                        </div>
                                        <div class="column is-one-third has-text-centered">
                                            <strong>Pickup by:</strong>
                                            <br>
                                            {{ order.donation.pickup_by }}
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <footer class="card-footer">
                                <a href="#" class="card-footer-item">Modify</a>
                                <form method="post" action="{% url 'cancel_order' order.order_id %}" class="cancel-form">
                                    {% csrf_token %}
                                    <button type="submit" 
                                            class="card-footer-item has-text-danger cancel-button"
                                            onclick="return confirm('Are you sure you want to cancel this reservation?')">
                                        Cancel
                                    </button>
                                </form>
                            </footer>
                        </div>
                    </div>
                {% endfor %}
            </div>
        {% else %}
            <div class="box">
                No pending orders.
            </div>
        {% endif %}
    </div>

    <!-- Picked Up Orders Section -->
    <div id="picked-up-orders" class="order-list is-hidden">
        {% if picked_up_orders %}
            <div class="columns is-multiline is-variable is-4">
                {% for order in picked_up_orders %}
                    <div class="column is-full-mobile is-half-tablet is-half-desktop">
                        <div class="card mb-5">
                            <div class="card-content">
                                <div class="media is-flex is-justify-content-space-between is-flex-direction-column-mobile">
                                    <div class="media-content">
                                        <p class="title is-4">{{ order.donation.food_item }}</p>
                                    </div>
                                    <div class="media-right mt-2-mobile">
                                        <span class="tag is-primary is-light is-medium mt-1">{{ order.order_quantity }} reserved</span>
                                    </div>
                                </div>

                                <div class="content">
                                    <div class="columns is-flex-direction-column-mobile">
                                        <div class="column is-two-thirds">
                                            <a href="https://www.google.com/maps/dir/?api=1&destination={{ order.donation.organization.address|urlencode }}"
                                               class="button is-link is-light is-fullwidth address-link"
                                               target="_blank" 
                                               rel="noopener noreferrer">
                                                {{ order.donation.organization.organization_name }}
                                                {{ order.donation.organization.address }}
                                            </a>
                                        </div>
                                        <div class="column is-one-third has-text-centered">
                                            <strong>Pickup by:</strong>
                                            <br>
                                            {{ order.donation.pickup_by }}
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <footer class="card-footer">
                                <div class="card-footer-button">Completed</div>
                            </footer>
                        </div>
                    </div>
                {% endfor %}
            </div>
        {% else %}
            <div class="box">
                No picked up orders.
            </div>
        {% endif %}
    </div>

    <!-- Canceled Orders Section -->
    <div id="canceled-orders" class="order-list is-hidden">
        {% if canceled_orders %}
            <div class="columns is-multiline is-variable is-4">
                {% for order in canceled_orders %}
                    <div class="column is-full-mobile is-half-tablet is-half-desktop">
                        <div class="card mb-5">
                            <div class="card-content">
                                <div class="media is-flex is-justify-content-space-between is-flex-direction-column-mobile">
                                    <div class="media-content">
                                        <p class="title is-4">{{ order.donation.food_item }}</p>
                                    </div>
                                    <div class="media-right mt-2-mobile">
                                        <span class="tag is-primary is-light is-medium mt-1">{{ order.order_quantity }} reserved</span>
                                    </div>
                                </div>

                                <div class="content">
                                    <div class="columns is-flex-direction-column-mobile">
                                        <div class="column is-two-thirds">
                                            <a href="https://www.google.com/maps/dir/?api=1&destination={{ order.donation.organization.address|urlencode }}"
                                               class="button is-link is-light is-fullwidth address-link"
                                               target="_blank" 
                                               rel="noopener noreferrer">
                                                {{ order.donation.organization.organization_name }}
                                                {{ order.donation.organization.address }}
                                            </a>
                                        </div>
                                        <div class="column is-one-third has-text-centered">
                                            <strong>Pickup by:</strong>
                                            <br>
                                            {{ order.donation.pickup_by }}
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <footer class="card-footer">
                                <div class="card-footer-button">Canceled</div>
                            </footer>
                        </div>
                    </div>
                {% endfor %}
            </div>
        {% else %}
            <div class="box">
                No cancelled orders.
            </div>
        {% endif %}
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', () => {
    const tabs = document.querySelectorAll('.tabs li');
    const orderLists = document.querySelectorAll('.order-list');

    tabs.forEach(tab => {
        tab.addEventListener('click', () => {
            tabs.forEach(t => t.classList.remove('is-active'));
            tab.classList.add('is-active');
            orderLists.forEach(list => list.classList.add('is-hidden'));
            const targetId = tab.getAttribute('data-target');
            document.getElementById(targetId).classList.remove('is-hidden');
        });
    });
});
</script>
{% endblock content %}